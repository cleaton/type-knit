import{z as f}from"zod";var u=class{constructor(){this.topsub=new Map;this.nextSubid=0}emit(t,r){let e=this.topsub.get(t);if(e){for(let n of e.values())n(r);r.type==="close"&&(e.clear(),this.topsub.delete(t))}}subscribe(t,r){let e=++this.nextSubid,n=this.topsub.get(t);return n||(n=new Map,this.topsub.set(t,n)),n.set(e,r),()=>{(n==null?void 0:n.delete(e))&&(n==null?void 0:n.size)===0&&this.topsub.delete(t)}}},C=new TextEncoder;function h(a){let t={},r=new ReadableStream({start(){},async pull(e){let c=await(t.channel?t.channel:new Promise(y=>{t.resolve=y}));if(c.type==="close")e.close();else{let y=JSON.stringify(c.data);e.enqueue(C.encode(y+`
`))}},async cancel(e){a()}});return{publish:e=>{if(t.resolve){let n=t.resolve;t.resolve=void 0,n(e)}else t.channel=new Promise(n=>n(e))},readable:r}}var x=class{constructor(t){this.emitter=t||new u}emit(t,r){this.emitter.emit(t,r)}instance(t,r,e,n=[]){return{_type:"instance",_schema:e,_middlewares:n,instance:(c,y)=>({fetch:r(c,y)})}}call(t,r,e=[]){return{_type:"call",_schema:t,_middlewares:e,call:r}}stream(t,r,e=[]){return{_type:"stream",_schema:t,_middlewares:e,stream:r}}router(t,r=[]){return{...t,_middlewares:r,_type:"router",route:async e=>{let c=new URL(e.req.url).pathname.split("/");c.shift();let y=c.shift();for(let T of r){let o=T.handle(e);if(o.type=="response")return o.data;e={...o.data,__tk_internals:e.__tk_internals}}if(!e.__tk_internals){let o=new URL(e.req.url).pathname.split("/");o.shift();let s=await e.req.json();if(typeof s!="object")return new Response("bad request",{status:400});if(s.args=s.args?s.args:[],!Array.isArray(s.args))return new Response("bad request",{status:400});e.__tk_internals={index:0,paths:o,tkreq:s}}let p=t[e.__tk_internals.paths[e.__tk_internals.index]];switch(p._type){case"call":{let T=e.__tk_internals.tkreq.args.shift(),o=p._schema.safeParse(T),s=p.call(o.data,e);if(s.error){let d=s.status?s.status:400;return new Response(s.error,{status:d})}return new Response(JSON.stringify(s),{status:200})}case"stream":{let T=e.__tk_internals.tkreq.args.shift(),o=p._schema.safeParse(T),s=p.stream(o,e);if(s.type==="error"){let m=s.status?s.status:400;return new Response(s.error,{status:m})}let d,v=this.emitter.subscribe(s.topic,m=>d&&d(m)),S=h(()=>v());return d=S.publish,new Response(S.readable,{status:200,headers:{"Content-Type":"text/event-stream",Connection:"keep-alive","Cache-Control":"no-cache"}})}case"instance":{let T=await e.req.json(),o=p._schema.safeParse(T),{fetch:s}=p.instance(o,e);return s(e.req)}case"router":return++e.__tk_internals.index,p.route(e)}return new Response("route not found",{status:404})}}}},l=f.object({username:f.string()}),i=new x,O=i.router({other:{_type:"call",_middlewares:[],_schema:l,call:a=>"hi"}}),_=i.router({test2:i.call(l,a=>a.username)}),R=i.router({test2:i.call(l,a=>a.username)}),P=i.router({test:i.call(l,a=>13),subrouter:_,instancerouter:i.instance(R,(a,t)=>fetch,l),st:i.stream(l,a=>({type:"success",topic:"topica",initValue:"test2"}))});var A=i.call(l,a=>a.username),g={f:()=>a=>({test:"hi"})};g.f()({hi:"hello"});export{x as TKBuilder};
