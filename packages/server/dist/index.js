"use strict";var S=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var E=(s,t)=>{for(var r in t)S(s,r,{get:t[r],enumerable:!0})},b=(s,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of R(t))!g.call(s,n)&&n!==r&&S(s,n,{get:()=>t[n],enumerable:!(e=_(t,n))||e.enumerable});return s};var k=s=>b(S({},"__esModule",{value:!0}),s);var M={};E(M,{TKBuilder:()=>m});module.exports=k(M);var h=require("zod");var u=class{constructor(){this.topsub=new Map;this.nextSubid=0}emit(t,r){let e=this.topsub.get(t);if(e){for(let n of e.values())n(r);r.type==="close"&&(e.clear(),this.topsub.delete(t))}}subscribe(t,r){let e=++this.nextSubid,n=this.topsub.get(t);return n||(n=new Map,this.topsub.set(t,n)),n.set(e,r),()=>{(n==null?void 0:n.delete(e))&&(n==null?void 0:n.size)===0&&this.topsub.delete(t)}}},K=new TextEncoder;function v(s){let t={},r=new ReadableStream({start(){},async pull(e){let c=await(t.channel?t.channel:new Promise(y=>{t.resolve=y}));if(c.type==="close")e.close();else{let y=JSON.stringify(c.data);e.enqueue(K.encode(y+`
`))}},async cancel(e){s()}});return{publish:e=>{if(t.resolve){let n=t.resolve;t.resolve=void 0,n(e)}else t.channel=new Promise(n=>n(e))},readable:r}}var m=class{constructor(t){this.emitter=t||new u}emit(t,r){this.emitter.emit(t,r)}instance(t,r,e,n=[]){return{_type:"instance",_schema:e,_middlewares:n,instance:(c,y)=>({fetch:r(c,y)})}}call(t,r,e=[]){return{_type:"call",_schema:t,_middlewares:e,call:r}}stream(t,r,e=[]){return{_type:"stream",_schema:t,_middlewares:e,stream:r}}router(t,r=[]){return{...t,_middlewares:r,_type:"router",route:async e=>{let c=new URL(e.req.url).pathname.split("/");c.shift();let y=c.shift();for(let T of r){let o=T.handle(e);if(o.type=="response")return o.data;e={...o.data,__tk_internals:e.__tk_internals}}if(!e.__tk_internals){let o=new URL(e.req.url).pathname.split("/");o.shift();let a=await e.req.json();if(typeof a!="object")return new Response("bad request",{status:400});if(a.args=a.args?a.args:[],!Array.isArray(a.args))return new Response("bad request",{status:400});e.__tk_internals={index:0,paths:o,tkreq:a}}let p=t[e.__tk_internals.paths[e.__tk_internals.index]];switch(p._type){case"call":{let T=e.__tk_internals.tkreq.args.shift(),o=p._schema.safeParse(T),a=p.call(o.data,e);if(a.error){let d=a.status?a.status:400;return new Response(a.error,{status:d})}return new Response(JSON.stringify(a),{status:200})}case"stream":{let T=e.__tk_internals.tkreq.args.shift(),o=p._schema.safeParse(T),a=p.stream(o,e);if(a.type==="error"){let x=a.status?a.status:400;return new Response(a.error,{status:x})}let d,C=this.emitter.subscribe(a.topic,x=>d&&d(x)),f=v(()=>C());return d=f.publish,new Response(f.readable,{status:200,headers:{"Content-Type":"text/event-stream",Connection:"keep-alive","Cache-Control":"no-cache"}})}case"instance":{let T=await e.req.json(),o=p._schema.safeParse(T),{fetch:a}=p.instance(o,e);return a(e.req)}case"router":return++e.__tk_internals.index,p.route(e)}return new Response("route not found",{status:404})}}}},l=h.z.object({username:h.z.string()}),i=new m,Z=i.router({other:{_type:"call",_middlewares:[],_schema:l,call:s=>"hi"}}),w=i.router({test2:i.call(l,s=>s.username)}),q=i.router({test2:i.call(l,s=>s.username)}),F=i.router({test:i.call(l,s=>13),subrouter:w,instancerouter:i.instance(q,(s,t)=>fetch,l),st:i.stream(l,s=>({type:"success",topic:"topica",initValue:"test2"}))});var B=i.call(l,s=>s.username),I={f:()=>s=>({test:"hi"})};I.f()({hi:"hello"});0&&(module.exports={TKBuilder});
